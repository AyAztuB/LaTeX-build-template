name: Build and Publish PDFs

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build PDFs with texlive/texlive
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workdir \
            -w /workdir \
            texlive/texlive:latest \
            /bin/bash -c "apt-get update && apt-get install -y bc wget && make"

      - name: Upload PDFs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdfs
          path: |
            *.pdf
            **/*.pdf

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download PDFs
        uses: actions/download-artifact@v4
        with:
          name: pdfs
          path: public

      - name: Generate index.html
        run: |
          {
            echo "<!DOCTYPE html>"
            echo "<html><head><meta charset='UTF-8'><title>Available PDFs</title></head><body>"
            echo "<h1>Available PDFs</h1><ul>"
            for pdf in $(find public -type f -name "*.pdf"); do
              relpath="${pdf#public/}"
              echo "<li><a href=\"$relpath\">$relpath</a></li>"
            done
            echo "</ul></body></html>"
          } > public/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_WPAT }}
          publish_dir: ./public

